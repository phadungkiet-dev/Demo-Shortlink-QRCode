// ตัวสร้าง Client สำหรับใช้ใน Node.js
generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

// กำหนด Database เป็น PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ตารางผู้ใช้งาน (Users) ---
model User {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  passwordHash String? @map("password_hash") // Map ชื่อ column ใน DB
  provider     String  @default("LOCAL") // 'LOCAL', 'GOOGLE'
  providerId   String? @map("provider_id")
  role         String  @default("USER")
  isBlocked    Boolean @default(false) @map("is_blocked")
  linkLimit    Int     @default(10) @map("link_limit")

  resetPasswordToken   String?   @map("reset_password_token")
  resetPasswordExpires DateTime? @map("reset_password_expires")

  // Timestamps (Create/Update อัตโนมัติ)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  links Link[]

  // ตั้งชื่อตารางจริงใน DB ว่า 'users' (พหูพจน์)
  @@map("users")
}

// --- ตารางลิงก์ (Links) ---
model Link {
  id        Int      @id @default(autoincrement())
  slug      String   @unique
  targetUrl String   @map("target_url")
  isPublic  Boolean  @default(false) @map("is_public")
  disabled  Boolean  @default(false)
  expiredAt DateTime @map("expired_at")

  // JSON เก็บ Config QR Code (ยืดหยุ่น ไม่ต้องแก้ Schema บ่อย)
  qrOptions Json? @map("qr_options")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  ownerId Int?    @map("owner_id")
  owner   User?   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  clicks  Click[]

  // Indexes เพื่อความเร็วในการค้นหาของ Admin และ User
  @@index([ownerId])
  @@index([createdAt])
  @@map("links")
}

// --- ตารางสถิติการคลิก (Clicks) ---
model Click {
  id        Int     @id @default(autoincrement())
  ip        String
  userAgent String? @map("user_agent")
  referrer  String?

  // [New Features] Geo-Location
  country String? // รหัสประเทศ (เช่น TH, US, JP)
  city    String? // ชื่อเมือง (เช่น Bangkok, Tokyo)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  linkId Int  @map("link_id")
  link   Link @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@index([linkId])
  @@index([createdAt]) // ช่วยให้ query กราฟย้อนหลังเร็วขึ้น
  @@map("clicks")
}

// --- ตาราง Session (สำหรับ express-session) ---
// ใช้เก็บ Session การ Login ของ User ลง DB แทนที่จะเก็บใน RAM
model Session {
  sid    String   @id // Session ID
  sess   Json // ข้อมูล Session (User ID, Cookie info)
  expire DateTime @db.Timestamp(6) // เวลาหมดอายุ

  // Map ชื่อตารางจริงใน DB ให้เป็น "user_sessions" (ตาม convention ของ connect-pg-simple)
  @@index([expire], map: "IDX_session_expire")
  @@map("user_sessions") // Index ช่วยให้ลบ Session หมดอายุได้เร็ว
}
